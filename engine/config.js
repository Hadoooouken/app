// engine/config.js
// ЕДИНАЯ ТОЧКА НАСТРОЕК ПРОЕКТА.
//
// Идея:
// - В коде НЕ должно быть "магических чисел" и цветов.
// - Всё, что связано с единицами, сеткой, толщинами, допусками, UI-стилями — здесь.
// - В файлах проекта импортируешь `config` и берёшь нужные параметры.
// - Производные значения (зависящие от других) считаем функциями (см. CLEAR_FROM_CAPITAL()).
//
// ⚠️ Важно про размеры:
// - world units = твои координаты (сейчас 1 unit = 1 cm)
// - px = экранные пиксели (нужно переводить в world через invScale = 1/scale)
//   Это критично для “зоны клика” (pick) и снапа (snapPx/axisPx),
//   чтобы на любом зуме ощущалось одинаково.

export const config = {
    // -------------------------
    // UNITS / SCALE
    // -------------------------
    units: {
        // Текстовое название единиц world-координат (для UI/понимания).
        // Сейчас: 1 world unit = 1 cm.
        UNIT: 'cm',

        // Сколько world-единиц в 1 метре.
        // Для cm это 100, для mm было бы 1000, для m — 1.
        // Используется в метриках: длины/площади → метры.
        UNITS_PER_M: 100,
    },

    // -------------------------
    // GRID
    // -------------------------
    grid: {
        // Шаг ВИЗУАЛЬНОЙ сетки на фоне (world units).
        // Например 100 при cm => клетка 1м.
        viewStep: 100,

        // Шаг МАГНИТА (снап к сетке) при рисовании/редактировании (world units).
        // Например 25 при cm => привязка 25см.
        snapStep: 25,
    },

    // -------------------------
    // WALLS GEOMETRY
    // -------------------------
    walls: {
        // Толщина капитальной стены при отрисовке (world units).
        CAP_W: 40,

        // Толщина normal стены при отрисовке (world units).
        NOR_W: 10,

        // “Перекрытие” на стыке normal к capital (world units).
        // Нужно, чтобы визуально не было щели и normal “аккуратно входила” в стену.
        OVERLAP: 5,

        // Минимальная длина normal стены (world units).
        // Сейчас: 50cm. Нужна, чтобы не создавать микростены кликом/ошибкой.
        MIN_LEN: 50,
    },

    // -------------------------
    // DOORS
    // -------------------------
    doors: {
        // Стандартная ширина межкомнатной двери (world units).
        // Используется при постановке двери и в preview, если d.w не задан.
        defaultInteriorW: 75,

        // Стандартная ширина входной двери (world units).
        defaultEntryW: 90,

        // Ограничение: одна межкомнатная дверь (interior) на одну стену.
        oneInteriorPerWall: true,

        // Шаг сдвига двери стрелками (world units).
        // Обычно удобно = шагу магнита (grid.snapStep), но можно отдельно.
        nudgeStepWorld: 25,
    },
    windows: {
        // стандартное окно 1.0м (world units, у тебя cm → 100)
        defaultW: 100,

        // балконное/остекление (пример: 180см)
        balconyW: 180,

        // визуальная "толщина" окна (если не задано в объекте окна)
        // можно сделать чуть меньше толщины капитальной
        thickMulOfCap: 0.65,

        // небольшой вынос от оси капитальной наружу (в world units)
        // чтобы читалось как проём на стене
        outwardOffsetWorld: 2,
    },

    // -------------------------
    // SNAP (магниты/допуски в пикселях)
    // -------------------------
    snap: {
        // Настройки снапа для РИСОВАНИЯ (draw-wall).
        // snapPx/axisPx задаются в PX и переводятся в world через (px * invScale).
        draw: {
            // Радиус “прилипания” к точкам/сетке/капиталкам (px).
            snapPx: 22,

            // Допуск для “выравнивания по оси” (гориз/вертикаль от точки A) (px).
            axisPx: 14,
        },

        // Настройки снапа для РЕДАКТИРОВАНИЯ (move/resize).
        edit: {
            snapPx: 14,
            axisPx: 10,
        },

        // Порог “попадания” (pick) — это НЕ снап, это UX-область клика/ховера.
        // Это ОБЯЗАТЕЛЬНО должно быть в PX и переводиться в world через invScale,
        // иначе на разных зумах “попасть” будет то легко, то невозможно.
        pick: {
            // Толщина “зоны клика” по телу стены (px).
            wallPx: 16,

            // Толщина “зоны клика” у хэндлов (концов) стены (px).
            handlePx: 14,

            // Толщина “зоны клика” по двери (px).
            // Обычно чуть больше, чем wallPx, потому что дверь короче.
            doorPx: 18,
        },

        // Защита от T-снапа возле концов normal стен:
        // если t близко к 0/1 — не считаем это T-стыком, пусть отработает снап к точкам.
        tGuard: 0.08,
    },

    // -------------------------
    // CONSTRAINTS (ограничения валидности)
    // -------------------------
    constraints: {
        // Сколько проверочных точек брать при тесте "сегмент внутри полигона капиталок".
        // Больше — точнее, но тяжелее.
        insideSteps: 24,

        // Проверка “не утопить normal в capital”:
        // endGuard — доля около концов, которую НЕ проверяем (чтобы можно было пристыковаться)
        // samples — сколько точек внутри сегмента проверять
        clear: {
            endGuard: 0.06,
            samples: 24,
        },

        // Для режима рисования (draw-wall) clearance делаем мягче, чтобы UX был легче:
        // DRAW_CLEAR = CLEAR_FROM_CAPITAL() * drawClearMul
        drawClearMul: 0.1,
    },

    // -------------------------
    // ROOMS (поиск помещений)
    // -------------------------
    rooms: {
        // Минимальная площадь помещения, которое показываем (м²).
        // Маленькие “кусочки” не отображаем.
        minAreaM2: 0.8,

        // Точность polylabel (world units).
        // Больше — быстрее, меньше — точнее (но дороже).
        polylabelPrecisionWorld: 2.0,
    },

    // -------------------------
    // RENDER (то, что относится к отрисовке/визуалу)
    // -------------------------
    render: {
        // Размер “мира” для SVG pattern-grid (world units).
        // Огромный прямоугольник, чтобы сетка покрывала сцену при панорамировании.
        worldSize: 24000,

        // Длительность snapPulse анимации (мс).
        snapPulseMs: 350,

        // Настройки размерных подписей (длины стен).
        // Важно:
        // - fontPx/padPx — в PX и масштабируются через invScale
        // - offset* — в world units и тоже умножаются на invScale (чтобы выглядеть одинаково на экране)
        dim: {
            // Размер шрифта подписи длины стены (px).
            fontPx: 12,

            // Паддинг фона под подписью (px).
            padPx: 3,

            offsetNormalPx: 14,
            offsetCapitalExtraPx: 14
        },

        // Плашка “Коробка: W × H м” (можно выключать)
        boxLabel: {
            enabled: true,  // false = вообще не рисуем
            fontPx: 13,     // px
            padPx: 4,       // px
            radiusPx: 6,    // px
            offsetPx: 70,   // px (насколько вверх от верхней границы коробки)
            bgOpacity: 0.9, // прозрачность фона
        },

        // Подписи площадей комнат “XX м²”
        rooms: {
            // Размер текста площади (px, будет стабилен на зуме через invScale)
            fontPx: 14,
        },

        // Радиус хэндлов (кружков на концах выбранной стены) (world units).
        handles: { r: 12 },

        // Толщина preview линии (штриховая линия при рисовании) (world units).
        preview: { strokeW: 6 },
    },

    // -------------------------
    // HISTORY (undo/redo)
    // -------------------------
    history: {
        // Максимальная длина истории undo (кол-во снапшотов).
        MAX: 80,
    },

    // -------------------------
    // THEME (все цвета и стили UI)
    // -------------------------
    theme: {
        wall: {
            // Цвет капитальных стен
            capital: '#2a4f3d',

            // Базовый цвет normal стен
            normal: '#2a4f3d',

            // Цвет выделения (selected)
            selected: 'rgba(53, 102, 78, 1)',

            // Цвет наведения (hover)
            hover: 'rgba(42, 79, 61, 0.9)',

            // Прозрачность normal стены при hover/selected
            hoverOpacity: 0.95,
            selectedOpacity: 1,

            // Дополнительная толщина normal стены при hover/selected (world units)
            hoverExtraW: 2,
            selectedExtraW: 4,
        },

        door: {
            // Цвет входной двери
            entry: '#4b2f23',

            // Цвет межкомнатной двери
            interior: '#c8a07a',

            // Цвет выделения двери
            selected: 'rgba(200, 160, 122, 0.8)',

            // Цвет наведения двери
            hover: 'rgba(200, 160, 122, 0.9)',

            // Цвет preview двери в режиме draw-door
            preview: 'rgba(196,154,108,0.75)',
        },

        window: {
            // цвет проёма/стекла
            fill: 'rgba(160, 210, 255, 0.85)',
            // обводка
            stroke: 'rgba(40, 90, 140, 0.9)',
        },

        // Цвет линий сетки
        grid: { line: '#e3d7d9' },

        // Цвета/прозрачности размерных подписей
        dim: {
            text: '#111',
            bg: '#ffffff',
            bgOpacity: 0.75,
        },

        // Цвета курсора (точка курсора в draw-wall)
        cursor: {
            idle: '#111',
            invalid: '#ff3b30',
        },

        // Стиль подписей площадей комнат (rooms)
        rooms: {
            // Цвет текста “XX м²”
            text: '#111',

            // Обводка текста для контраста на фоне
            stroke: 'rgba(255,255,255,0.9)',

            // Относительная толщина обводки:
            // strokeWidth = fontWorld * strokeMul
            strokeMul: 0.25,
        },
    },
}

// -------------------------
// DERIVED (производные значения)
// -------------------------
//
// Это “минимальная дистанция” от ОСИ капитальной стены,
// чтобы normal стена визуально не залезала в толщину капитальной.
//
// Важно:
// - возвращает число в world units
// - это функция, потому что зависит от CAP_W/NOR_W/OVERLAP и должна пересчитываться автоматически.
export function CLEAR_FROM_CAPITAL() {
    const { CAP_W, NOR_W, OVERLAP } = config.walls
    return (CAP_W / 2) + (NOR_W / 2) - OVERLAP
}